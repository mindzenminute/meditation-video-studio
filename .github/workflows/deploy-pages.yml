# ============================================================
# PARTIE 1 : LE NOM
# ============================================================
# C'est juste un nom lisible. Tu le verras dans l'onglet "Actions" de GitHub.
# Tu peux mettre ce que tu veux.

name: Deploy Remotion Preview to GitHub Pages


# ============================================================
# PARTIE 2 : QUAND EST-CE QUE LE ROBOT SE RÉVEILLE ?
# ============================================================

on:
  # Se déclenche quand tu push sur la branche "main"
  push:
    branches: [ main ]

  # Permet aussi de le lancer à la main depuis l'interface GitHub
  # (bouton "Run workflow" dans l'onglet Actions)
  workflow_dispatch:


# ============================================================
# PARTIE 3 : LES PERMISSIONS
# ============================================================
# Le robot a besoin de certains "droits" pour faire son travail.
# C'est comme donner les clés de la maison au plombier.

permissions:
  contents: read        # Peut LIRE ton code (mais pas le modifier)
  pages: write          # Peut ÉCRIRE sur GitHub Pages (pour publier le site)
  id-token: write       # Peut prouver son identité (sécurité interne GitHub)


# ============================================================
# PARTIE 4 : ÉVITER LES EMBOUTEILLAGES
# ============================================================
# Si tu push 3 fois en 1 minute, on ne veut pas 3 robots qui
# se marchent dessus. On garde seulement le dernier.

concurrency:
  group: "pages"
  cancel-in-progress: false   
  # false = on attend que le précédent finisse avant de lancer le suivant
  # true  = on annule le précédent et on lance le nouveau


# ============================================================
# PARTIE 5 : LES JOBS (LES TÂCHES)
# ============================================================
# Un job = un groupe de tâches qui s'exécutent sur UN robot.
# On a 2 jobs : "build" (construire) et "deploy" (publier).

jobs:

  # ──────────────────────────────────────────────
  # JOB 1 : CONSTRUIRE LE SITE
  # ──────────────────────────────────────────────
  build:
    # Sur quel type de machine le robot travaille ?
    # ubuntu-latest = un ordinateur Linux gratuit fourni par GitHub
    runs-on: ubuntu-latest

    # Les étapes, exécutées dans l'ordre, une par une :
    steps:

      # ÉTAPE 1 : Récupérer ton code
      # ─────────────────────────────
      # Le robot est une machine VIERGE. Il ne connaît pas ton code.
      # Cette étape télécharge ton repository dans la machine.
      # C'est comme dire "va chercher les plans de construction".
      - name: Checkout
        uses: actions/checkout@v4
        # "uses" = utilise une action pré-faite par GitHub
        # "actions/checkout@v4" = action officielle, version 4

      # ÉTAPE 2 : Installer Node.js
      # ─────────────────────────────
      # Le robot n'a pas Node.js installé par défaut.
      # On lui dit "installe Node.js version 20".
      # Et "cache: npm" = garde les packages en mémoire pour la prochaine fois
      # (comme garder les ingrédients dans le frigo au lieu de refaire les courses).
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # ÉTAPE 3 : Installer les dépendances
      # ─────────────────────────────────────
      # "npm ci" = installe exactement les packages listés dans package-lock.json
      # C'est comme "npm install" mais plus strict et plus rapide.
      # Parfait pour les robots (pas d'ambiguïté).
      - name: Install dependencies
        run: npm ci
        # "run" = exécute cette commande dans le terminal du robot

      # ÉTAPE 4 : Construire le bundle Remotion
      # ─────────────────────────────────────────
      # Exécute le script "build:pages" de ton package.json
      # qui fait : npx remotion bundle --public-path="./"
      # 
      # Le résultat : un dossier "build/" contenant tous les fichiers
      # HTML/CSS/JS nécessaires pour afficher les vidéos dans un navigateur.
      - name: Build for GitHub Pages
        run: npm run build:pages

      # ÉTAPE 5 : Configurer GitHub Pages
      # ─────────────────────────────────
      # Prépare le système de Pages pour recevoir les fichiers.
      # C'est comme préparer l'étagère avant de poser les livres.
      - name: Setup Pages
        uses: actions/configure-pages@v4

      # ÉTAPE 6 : Emballer les fichiers
      # ─────────────────────────────────
      # Prend tout le contenu du dossier "build/" et l'emballe
      # dans un "artifact" (= un colis) pour le job suivant.
      # 
      # Pourquoi ? Parce que le Job 2 (deploy) tourne sur une
      # AUTRE machine. Il faut transférer les fichiers.
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'build'
          # ↑ Le dossier à emballer. Doit correspondre à la sortie de "npm run build:pages"


  # ──────────────────────────────────────────────
  # JOB 2 : PUBLIER LE SITE
  # ──────────────────────────────────────────────
  deploy:
    # Ce job a BESOIN que le job "build" soit terminé avec succès.
    # Si "build" échoue, "deploy" ne se lance même pas.
    needs: build

    runs-on: ubuntu-latest

    # Déclare un "environnement" GitHub pour suivre les déploiements.
    # Tu pourras voir l'URL directement dans l'onglet Actions.
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      #     ↑ Variable magique : l'URL finale de ton site

    steps:
      # UNE SEULE ÉTAPE : publier les fichiers emballés
      - name: Deploy to GitHub Pages
        id: deployment
        # ↑ "id" permet aux autres étapes/jobs de référencer celle-ci
        #   (c'est grâce à ça que "steps.deployment.outputs.page_url" fonctionne)
        uses: actions/deploy-pages@v4
        # Cette action :
        # 1. Récupère l'artifact (le colis) du job "build"
        # 2. Le décompresse
        # 3. Le publie sur GitHub Pages
        # 4. Fournit l'URL finale
